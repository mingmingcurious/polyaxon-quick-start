version: 1.1
kind: operation
name: build
params:
  destination:
    #docker仓库连接，镜像构建完成后推送到这个仓库
    connection: registry-polyaxon
    value: polyaxon/polyaxon-quick-start:xw
runPatch:
  #指定域名解析
  environment:
    hostAliases:
    - ip: "172.16.1.33"
      hostnames:
      - "image.io"
  init:
  #构建镜像的配置
  - dockerfile:
      #基础镜像 FROM
      image: "tensorflow/tensorflow:2.4.2"
      #RUN命令
      run:
      - 'pip3 install --no-cache-dir -U polyaxon'
      #ENV命令
      langEnv: 'en_US.UTF-8'
hubRef: kaniko
#下面的component是指定了kaniko后polyaxon默认添加的，我拷贝过来同样可以用，
#并且增加了 - '--skip-tls-verify=true' 和 - '--insecure=true'，解决harbor没有配置https的问题
component:
  version: 1.1
  kind: component
  name: kaniko
  tags:
    - build-2
  run:
    kind: job
    connections:
      - '{{ params.destination.connection }}'
    container:
      args:
        - '-c'
        - '{{ context or globals.artifacts_path }}'
        - '-d'
        - >-
          {{ (connections[params.destination.connection].url + '/' + destination)
          if (params.destination.connection in connections and
          connections[params.destination.connection].url) else destination }}
        - '{{ cache }}'
        - '--cache-ttl={{ cache_ttl }}'
        - '{{ params.dockerfile.as_arg }}'
        #配置下面两个参数，让kaniko不使用https
        - '--skip-tls-verify=true'
        - '--insecure=true'
      image: gcr.io/kaniko-project/executor:latest
      imagePullPolicy: IfNotPresent
      name: polyaxon-main